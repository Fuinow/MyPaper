# 小白的扫描器之路之目录扫描

## 0x01 概述

​	黑盒测试中，目录扫描往往能够带来意外的收获，本章完成目录扫描模块，扫描原理还是基于常规的爆破。要完成该模块需要解决的最大问题是给出一个判断目录存在与否的标准，在常规的网站中，可以将状态码作为该标准，但仅仅通过状态码是不准确的，一些站点即使目录不存在也不会返回404，比如自定义错误页面，从而返回200。

## 0x02 判断标准

​	前面说了，部分网站并不能单从状态码确定目录是否存在，这里给出自己见到的一些网站对不存在目录的处理方式。

1. 自定义404页面。

   自定义404页面就是当服务器接收到一条访问不存在的目录的请求时，返回一个自定义的页面，通过这个页面来提示用户页面不存在，所以返回的状态码是200。比如：https://www.freebuf.com/

2. 30x跳转至其他页面

   一些站点在用户访问不存在目录时会返回30x，跳转至另一个页面，这个页面可能是一个自定义的错误页面，也可能是其他的正常页面，比如：https://www.jd.com，会将用户重定向至首页。

首先，总体的方案是先访问一个确定不存在的目录，提取该请求响应的特征作为判断页面不存在的依据。对于自定义404页面，我们可以先获取404页面，然后与我们的扫描请求返回的页面做对比，从而判断我们的请求是否为不存在目录。对于30x跳有两种方案，一是跟入跳转，获取跳转后的页面，后面就和第一种情况一样，判断页面相似性。二是不跟跳转，直接获取30x返回的Location，将其他请求响应的Location与其做对比判断目录是否存在。这里我选择第一种方案，因为urllib2本身会默认跟30x，我们只需要处理后面一步比较页面相似度，处理方式和自定义404页面一致。

因此，确定出以下判断目录存在的标准：**返回200且返回页面与404页面不相似**。这里先解释一下本模块对认定目录存在的范围。目录存在的状态码不止200，可能是403之类的，但本模块只收集200可访问的目录，因为可访问的目录价值更直接，如果想要收集其他状态的目录，可重新定义判断标准。

##  0x03 页面相似度

​	在获取到404页面后，剩下的步骤就是把扫描页面与404页面做对比，对于常规的站点，可以直接将返回的body与404页面做比较，一致则认为目录不存在，否则存在。但对于一些404页面为动态的站点直接比较无法正确做出判断，比如腾讯的404页面，页面中会有一部分为动态内容，

![](img\1.png)

​	虽然每次访问的页面不完全相同，但他们都有很大一部分是相同的，样式，js代码块等，为了区分正常页面与404页面，引入页面相似度的概念。通过一个0-1的值来衡量两个页面的相似程度，如果某页面与404的相似度值大于某个阙值，我们则认为该页面就是404页面，从而判定目录不存在。

​	实现页面相似度的对比我们使用python的`difflib`库，sqlmap识别waf时也用到的页面相似度的对比，使用的就是`difflib`库的`SequenceMatcher`类，该类的具体实现原理及使用方法参考：[sqlmap 内核分析 II: 核心原理-页面相似度算法实践](https://www.anquanke.com/post/id/159346)

## 0x04 简单流程

![](img\2.jpg)

再次声明，这里只拿200状态码的目录，403等目录没保留，需要的可自行修改。

## 0x05 代码实现

​	目录扫描模块会依赖扫描器其他的公共函数，我丑陋的代码就不贴了。：）



## 0x05 一些坑

1. gzip编码，无法正确比较页面 相似度，如：https://www.freebuf.com/

   检查返回头的`Content-Encoding`如果为gzip调用解码函数

   ```
   from gzip import GzipFile
   from StringIO import StringIO
   def gzip(data):
       buf = StringIO(data)
       f = gzip.GzipFile(fileobj=buf)
       return f.read()
   ```

2. 网络不稳定，获取404页面不准确。

   设置重试次数，由于获取404页面的获取对于目录扫描起到决定性的作用，可以retry多次。

3. 跳转页面太大，相似度计算过慢，如：https://www.jd.om/

   判断返回body大小，超过某阙值则截取一部分做比较

4. 运行报错

   ```python
   Traceback (most recent call last):
     File "D:\python27\lib\threading.py", line 801, in bootstrap_inner
       self.run()
     File "D:\python27\lib\threading.py", line 754, in run
       self.target(*self.args, **self.kwargs)
     File "E:\Fuinow\Fscan\Module\Dir_Scan.py", line 111, in brute
       print "[%d] not exispt : %s"%(num, url)
   IOError: [Errno 22] Invalid argument
   ```

   字典中文字符编码问题，导致的IO错误。

5. gevent携程与nmap冲突。

   使用gevent时要打mongkey_patch

   `monkey.patch_all()`

   打上补丁后扫描器的nmap模块解析异常，无法正确使用，没找到解决方法，于是改成了线程版。（解决方法还望大佬告知）

## 0x06 结语

   网上有很多目录扫描的工具，重复造轮子只是单纯的学习，去理解工具实现的原理，去解决实际中遇到的问题。在写之前觉得目录扫描很简单，就一个状态码的事，但实践了才知道里面的一些坑，有不足或错误之处还望大佬指点，本菜在此谢过。
